name: Monitoramento AutomÃ¡tico

on:
  schedule:
    # Executa diariamente Ã s 9:00 UTC (6:00 BRT)
    - cron: '0 9 * * *'
  workflow_dispatch: # Permite execuÃ§Ã£o manual

jobs:
  health-check:
    runs-on: ubuntu-latest

    steps:
    - name: Check Streamlit Cloud App
      run: |
        echo "ğŸ” Verificando disponibilidade da aplicaÃ§Ã£o no Streamlit Cloud..."
        response=$(curl -s -o /dev/null -w "%{http_code}" --max-redirs 3 -L --connect-timeout 10 https://algoritmos-visualizador.streamlit.app/)

        if [ $response -eq 200 ] || [ $response -eq 301 ] || [ $response -eq 302 ] || [ $response -eq 303 ]; then
          echo "âœ… Streamlit App estÃ¡ online (HTTP $response)"
          echo "APP_STATUS=online" >> $GITHUB_ENV
        elif [ $response -eq 503 ]; then
          echo "âš ï¸ Streamlit App em manutenÃ§Ã£o (HTTP $response)"
          echo "APP_STATUS=maintenance" >> $GITHUB_ENV
        elif [ $response -eq 000 ]; then
          echo "âŒ Streamlit App inacessÃ­vel (conexÃ£o falhou)"
          echo "APP_STATUS=offline" >> $GITHUB_ENV
        else
          echo "âŒ Streamlit App com problemas (HTTP $response)"
          echo "APP_STATUS=error" >> $GITHUB_ENV
          exit 1
        fi

    - name: Check GitHub Actions Status
      run: |
        echo "ğŸ” Verificando status do GitHub Actions..."
        echo "ğŸ“Š Workflow executado em: $(date)"
        echo "âœ… Sistema de monitoramento funcionando"

    - name: Generate Daily Report
      run: |
        echo "ğŸ“‹ RELATÃ“RIO DIÃRIO - $(date +'%Y-%m-%d')"
        echo "=================================="

        # Status da aplicaÃ§Ã£o baseado na verificaÃ§Ã£o
        if [ "${APP_STATUS}" = "online" ]; then
          echo "âœ… Streamlit App: Online e funcionando"
        elif [ "${APP_STATUS}" = "maintenance" ]; then
          echo "âš ï¸ Streamlit App: Em manutenÃ§Ã£o"
        elif [ "${APP_STATUS}" = "offline" ]; then
          echo "âŒ Streamlit App: InacessÃ­vel"
        else
          echo "â“ Streamlit App: Status desconhecido"
        fi

        echo "âœ… GitHub Actions: Funcionando"
        echo "âœ… Monitoramento: Ativo"
        echo "ğŸ”„ PrÃ³xima verificaÃ§Ã£o: $(date -d '+1 day' +'%Y-%m-%d 09:00 UTC')"
        echo ""
        echo "ğŸŒ URL da AplicaÃ§Ã£o: https://algoritmos-visualizador.streamlit.app"
        echo "ğŸ“Š Status HTTP: ${APP_STATUS:-desconhecido}"
